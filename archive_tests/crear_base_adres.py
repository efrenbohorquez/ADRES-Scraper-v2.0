#!/usr/bin/env python3
"""
üöÄ CREADOR DE BASE DE DATOS ADRES EN MONGODB ATLAS
Script para crear la base de datos 'taller_bigdata_adres' y poblarla con documentos
"""

from pymongo import MongoClient
from datetime import datetime
import ssl

# Tu configuraci√≥n espec√≠fica de Atlas
ATLAS_CONNECTION = "mongodb+srv://efrenbohorquezv_db_user:Central2025@cluster0.ljpppvo.mongodb.net/"
DATABASE_NAME = "taller_bigdata_adres"
COLLECTION_NAME = "documentos_adres"

def crear_conexion_atlas():
    """Crear conexi√≥n robusta a MongoDB Atlas"""
    print("üîß CONECTANDO A MONGODB ATLAS")
    print("=" * 50)
    
    try:
        # Configurar cliente con m√∫ltiples opciones de conectividad
        client = MongoClient(
            ATLAS_CONNECTION,
            tls=True,
            tlsAllowInvalidCertificates=True,
            serverSelectionTimeoutMS=15000,   # 15 segundos
            connectTimeoutMS=15000,
            socketTimeoutMS=15000,
            maxPoolSize=10,
            retryWrites=True,
            w='majority'
        )
        
        # Probar conexi√≥n con ping
        print("üì° Probando conexi√≥n...")
        client.admin.command('ping')
        print("‚úÖ Conexi√≥n EXITOSA a MongoDB Atlas")
        
        return client
        
    except Exception as e:
        print(f"‚ùå Error de conexi√≥n: {str(e)[:200]}...")
        
        # Intentar conexi√≥n alternativa sin SSL estricto
        try:
            print("üîÑ Intentando conexi√≥n alternativa...")
            client = MongoClient(
                ATLAS_CONNECTION,
                ssl=True,
                ssl_cert_reqs=ssl.CERT_NONE,
                serverSelectionTimeoutMS=30000,
                connectTimeoutMS=30000
            )
            client.admin.command('ping')
            print("‚úÖ Conexi√≥n alternativa EXITOSA")
            return client
        except Exception as e2:
            print(f"‚ùå Error en conexi√≥n alternativa: {str(e2)[:200]}...")
            return None

def crear_base_datos_adres(client):
    """Crear la base de datos y colecci√≥n para ADRES"""
    print(f"\nüìä CREANDO BASE DE DATOS: {DATABASE_NAME}")
    print("=" * 50)
    
    try:
        # Obtener la base de datos (se crea autom√°ticamente al insertar)
        db = client[DATABASE_NAME]
        collection = db[COLLECTION_NAME]
        
        print(f"‚úÖ Base de datos '{DATABASE_NAME}' lista")
        print(f"üìÅ Colecci√≥n '{COLLECTION_NAME}' lista")
        
        return db, collection
        
    except Exception as e:
        print(f"‚ùå Error creando base de datos: {e}")
        return None, None

def crear_documentos_demo(collection):
    """Crear documentos de demostraci√≥n para ADRES"""
    print(f"\nüìÑ CREANDO DOCUMENTOS DEMO")
    print("=" * 50)
    
    documentos_demo = [
        {
            "url_original": "https://normograma.adres.gov.co/demo/concepto_2024_001",
            "titulo": "Concepto ADRES 2024-001 - R√©gimen Subsidiado",
            "texto_completo": """
CONCEPTO T√âCNICO ADRES 2024-001

ASUNTO: Consulta sobre aplicaci√≥n del r√©gimen subsidiado en salud

CONSIDERACIONES:

El r√©gimen subsidiado en salud tiene como finalidad garantizar el acceso 
a los servicios de salud a la poblaci√≥n m√°s vulnerable del pa√≠s, mediante 
el aseguramiento y la prestaci√≥n de servicios incluidos en el Plan 
Obligatorio de Salud Subsidiado - POSS.

CONCEPTO:

Por lo anterior, este Administrador concept√∫a que es procedente la 
autorizaci√≥n solicitada, siempre y cuando se cumplan los requisitos 
establecidos en la Resoluci√≥n 3047 de 2008 y dem√°s normatividad aplicable.

FUNDAMENTOS JUR√çDICOS:
- Ley 100 de 1993
- Decreto 780 de 2016
- Resoluci√≥n 3047 de 2008
            """,
            "fecha_extraccion": datetime.now(),
            "longitud_caracteres": 756,
            "longitud_palabras": 108,
            "tipo_documento": "concepto_adres",
            "estado_procesamiento": "demo_creado",
            "metadatos_http": {
                "status_code": 200,
                "content_type": "text/html",
                "encoding": "utf-8"
            },
            "palabras_clave": ["r√©gimen subsidiado", "POSS", "Ley 100", "Resoluci√≥n 3047"],
            "terminos_juridicos": ["r√©gimen subsidiado", "aseguramiento", "normatividad aplicable"],
            "es_documento_demo": True,
            "origen": "taller_bigdata_educativo"
        },
        {
            "url_original": "https://normograma.adres.gov.co/demo/concepto_2024_002",
            "titulo": "Concepto ADRES 2024-002 - Recursos de Inversi√≥n",
            "texto_completo": """
CONCEPTO T√âCNICO ADRES 2024-002

ASUNTO: Consulta sobre manejo de recursos de inversi√≥n en salud

ANTECEDENTES:

La entidad consultante solicita concepto sobre la correcta aplicaci√≥n 
de los recursos destinados a la inversi√≥n en infraestructura de salud 
de primer nivel de atenci√≥n.

AN√ÅLISIS:

Los recursos del Sistema General de Participaciones destinados a salud 
deben orientarse prioritariamente al aseguramiento de la poblaci√≥n pobre 
no cubierta con subsidios a la demanda y a la prestaci√≥n de servicios 
de salud a la poblaci√≥n pobre en lo no cubierto con subsidios a la demanda.

CONCEPTO:

Se concept√∫a que los recursos pueden utilizarse para la finalidad 
consultada, siempre que se cumplan las condiciones establecidas en 
el art√≠culo 44 de la Ley 715 de 2001.

MARCO NORMATIVO:
- Ley 715 de 2001
- Decreto 028 de 2008
- Circular Externa 047 de 2015
            """,
            "fecha_extraccion": datetime.now(),
            "longitud_caracteres": 1024,
            "longitud_palabras": 142,
            "tipo_documento": "concepto_adres",
            "estado_procesamiento": "demo_creado", 
            "metadatos_http": {
                "status_code": 200,
                "content_type": "text/html",
                "encoding": "utf-8"
            },
            "palabras_clave": ["SGP", "inversi√≥n", "infraestructura", "primer nivel"],
            "terminos_juridicos": ["Sistema General de Participaciones", "subsidios a la demanda", "Ley 715"],
            "es_documento_demo": True,
            "origen": "taller_bigdata_educativo"
        },
        {
            "url_original": "https://normograma.adres.gov.co/demo/concepto_2024_003",
            "titulo": "Concepto ADRES 2024-003 - Afiliaci√≥n al R√©gimen Subsidiado",
            "texto_completo": """
CONCEPTO T√âCNICO ADRES 2024-003

ASUNTO: Procedimientos para afiliaci√≥n al r√©gimen subsidiado

CONSULTA:

Se solicita concepto sobre los procedimientos y requisitos para la 
afiliaci√≥n de poblaci√≥n vulnerable al r√©gimen subsidiado en salud.

MARCO LEGAL:

El art√≠culo 157 de la Ley 100 de 1993 establece que tienen derecho 
al r√©gimen subsidiado las personas que carezcan de capacidad de pago 
para afiliarse al r√©gimen contributivo.

DESARROLLO:

La afiliaci√≥n al r√©gimen subsidiado se realizar√° mediante la aplicaci√≥n 
de la encuesta del SISBEN, la cual permitir√° identificar a la poblaci√≥n 
objetivo del r√©gimen subsidiado en salud.

CONCLUSI√ìN:

Por lo expuesto, se concept√∫a que los procedimientos consultados se 
ajustan a la normatividad vigente, especialmente lo dispuesto en el 
Decreto 1011 de 2006 y sus modificaciones.

NORMATIVIDAD CITADA:
- Ley 100 de 1993, art. 157
- Decreto 1011 de 2006
- Resoluci√≥n 412 de 2000
            """,
            "fecha_extraccion": datetime.now(),
            "longitud_caracteres": 1156,
            "longitud_palabras": 163,
            "tipo_documento": "concepto_adres",
            "estado_procesamiento": "demo_creado",
            "metadatos_http": {
                "status_code": 200,
                "content_type": "text/html", 
                "encoding": "utf-8"
            },
            "palabras_clave": ["afiliaci√≥n", "SISBEN", "poblaci√≥n vulnerable", "capacidad de pago"],
            "terminos_juridicos": ["r√©gimen subsidiado", "r√©gimen contributivo", "normatividad vigente"],
            "es_documento_demo": True,
            "origen": "taller_bigdata_educativo"
        }
    ]
    
    try:
        # Insertar documentos
        resultado = collection.insert_many(documentos_demo)
        print(f"‚úÖ {len(resultado.inserted_ids)} documentos insertados exitosamente")
        
        # Mostrar IDs insertados
        print(f"üìã IDs de documentos creados:")
        for i, doc_id in enumerate(resultado.inserted_ids, 1):
            print(f"   {i}. {doc_id}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Error insertando documentos: {e}")
        return False

def crear_indices(collection):
    """Crear √≠ndices para optimizar b√∫squedas"""
    print(f"\nüîç CREANDO √çNDICES PARA B√öSQUEDAS")
    print("=" * 50)
    
    try:
        # √çndice √∫nico por URL
        collection.create_index("url_original", unique=True)
        print("‚úÖ √çndice √∫nico creado para 'url_original'")
        
        # √çndice por fecha
        collection.create_index("fecha_extraccion")
        print("‚úÖ √çndice creado para 'fecha_extraccion'")
        
        # √çndice por tipo de documento
        collection.create_index("tipo_documento")
        print("‚úÖ √çndice creado para 'tipo_documento'")
        
        # √çndice de texto completo para b√∫squedas
        collection.create_index([("titulo", "text"), ("texto_completo", "text")])
        print("‚úÖ √çndice de texto completo creado")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Error creando √≠ndices: {e}")
        return False

def verificar_base_datos(db, collection):
    """Verificar que la base de datos se cre√≥ correctamente"""
    print(f"\nüîç VERIFICANDO BASE DE DATOS CREADA")
    print("=" * 50)
    
    try:
        # Listar colecciones en la base de datos
        colecciones = db.list_collection_names()
        print(f"üìÅ Colecciones en '{DATABASE_NAME}':")
        for col in colecciones:
            print(f"   ‚Ä¢ {col}")
        
        # Contar documentos
        total_docs = collection.count_documents({})
        print(f"\nüìä Total de documentos en '{COLLECTION_NAME}': {total_docs}")
        
        # Mostrar documentos de ejemplo
        if total_docs > 0:
            print(f"\nüìÑ DOCUMENTOS ALMACENADOS:")
            for i, doc in enumerate(collection.find().limit(3), 1):
                print(f"\n   {i}. üìã {doc.get('titulo', 'Sin t√≠tulo')}")
                print(f"      üîó {doc.get('url_original', 'Sin URL')}")
                print(f"      üìä {doc.get('longitud_caracteres', 0)} caracteres")
                print(f"      üìÖ {doc.get('fecha_extraccion', 'Sin fecha')}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Error verificando: {e}")
        return False

def mostrar_instrucciones_atlas():
    """Mostrar c√≥mo verificar en Atlas Web"""
    print(f"\nüåê C√ìMO VERIFICAR EN MONGODB ATLAS WEB")
    print("=" * 60)
    print("1. üåê Ve a: https://cloud.mongodb.com/")
    print("2. üîê Inicia sesi√≥n con tu cuenta")
    print("3. üìä Haz clic en 'Browse Collections'")
    print(f"4. üìÅ Busca la base de datos: '{DATABASE_NAME}'")
    print(f"5. üìë Abre la colecci√≥n: '{COLLECTION_NAME}'")
    print("6. üéâ ¬°Deber√≠as ver tus 3 documentos demo!")
    print(f"\nüîç FILTRO √öTIL:")
    print('   {"es_documento_demo": true}')

def main():
    """Funci√≥n principal"""
    print("üéì CREADOR DE BASE DE DATOS TALLER ADRES")
    print("üõ°Ô∏è MONGODB ATLAS - DOCUMENTOS NORMATIVOS")
    print("=" * 70)
    
    # Conectar a Atlas
    client = crear_conexion_atlas()
    if not client:
        print("\n‚ùå No se pudo conectar. Verifica:")
        print("   ‚Ä¢ Tu IP est√° en Network Access whitelist")
        print("   ‚Ä¢ Credenciales son correctas")
        print("   ‚Ä¢ Cluster est√° activo")
        return False
    
    try:
        # Crear base de datos y colecci√≥n
        db, collection = crear_base_datos_adres(client)
        if not db or not collection:
            return False
        
        # Crear documentos demo
        if not crear_documentos_demo(collection):
            return False
        
        # Crear √≠ndices
        crear_indices(collection)
        
        # Verificar resultado
        verificar_base_datos(db, collection)
        
        print(f"\nüéâ ¬°BASE DE DATOS '{DATABASE_NAME}' CREADA EXITOSAMENTE!")
        mostrar_instrucciones_atlas()
        
        return True
        
    except Exception as e:
        print(f"\n‚ùå Error en proceso principal: {e}")
        return False
        
    finally:
        client.close()
        print(f"\nüîå Conexi√≥n cerrada")

if __name__ == "__main__":
    exito = main()
    if exito:
        print(f"\n‚úÖ PROCESO COMPLETADO - Actualiza tu Atlas y verifica")
    else:
        print(f"\n‚ùå PROCESO FALL√ì - Revisa errores arriba")